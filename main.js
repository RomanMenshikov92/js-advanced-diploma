!function(){"use strict";var e="prairie",t="desert",a="arctic",s="mountain";class r{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[],this.positionedCharacterArray=[],this.selectedIndex=-1,this.selectedIndexGreen=-1,this.selectedIndexRed=-1,this.selectedCharacter=null,this.counterCharacterPlayer1=0,this.counterCharacterPlayer2=0,this.roundGameOver=!1,this.gameOver=!1,this.themesArray=[e,t,a,s],this.currentTheme=-1,this.gameCtrl=null,this.scorePlayer1=0,this.scorePlayer2=0}bindToDOM(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=e}drawUi(e){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",(e=>this.onNewGameClick(e))),this.saveGameEl.addEventListener("click",(e=>this.onSaveGameClick(e))),this.loadGameEl.addEventListener("click",(e=>this.onLoadGameClick(e))),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(e);for(let e=0;e<this.boardSize**2;e+=1){const s=document.createElement("div");s.classList.add("cell","map-tile","map-tile-"+(t=e,a=this.boardSize,0===t?"top-left":t===a-1?"top-right":t===a*(a-1)?"bottom-left":t===a*a-1?"bottom-right":(t+1)%a==0?"right":t%a==0?"left":t<=a-1?"top":t>=a*(a-1)?"bottom":"center")),s.addEventListener("mouseenter",(e=>this.onCellEnter(e))),s.addEventListener("mouseleave",(e=>this.onCellLeave(e))),s.addEventListener("click",(e=>this.onCellClick(e))),this.boardEl.appendChild(s)}var t,a;this.cells=Array.from(this.boardEl.children)}redrawPositions(e){for(const e of this.cells)e.innerHTML="";for(const a of e){const e=this.boardEl.children[a.position],s=document.createElement("div");s.classList.add("character",a.character.type);const r=document.createElement("div");r.classList.add("health-level");const l=document.createElement("div");l.classList.add("health-level-indicator","health-level-indicator-"+((t=a.character.health)<15?"critical":t<50?"normal":"high")),l.style.width=`${a.character.health}%`,r.appendChild(l),s.appendChild(r),e.appendChild(s)}var t}addCellEnterListener(e){this.cellEnterListeners.push(e)}addCellLeaveListener(e){this.cellLeaveListeners.push(e)}addCellClickListener(e){this.cellClickListeners.push(e)}addNewGameListener(e){this.newGameListeners.push(e)}addSaveGameListener(e){this.saveGameListeners.push(e)}addLoadGameListener(e){this.loadGameListeners.push(e)}onCellEnter(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellEnterListeners.forEach((e=>e.call(this.gameCtrl,t)))}onCellLeave(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellLeaveListeners.forEach((e=>e.call(null,t)))}onCellClick(e){const t=this.cells.indexOf(e.currentTarget);this.cellClickListeners.forEach((e=>e.call(this.gameCtrl,t)))}onNewGameClick(e){e.preventDefault(),this.newGameListeners.forEach((e=>e.call(this.gameCtrl)))}onSaveGameClick(e){e.preventDefault(),this.saveGameListeners.forEach((e=>e.call(this.gameCtrl)))}onLoadGameClick(e){e.preventDefault(),this.loadGameListeners.forEach((e=>e.call(this.gameCtrl)))}static showError(e){alert(e)}static showMessage(e){alert(e)}selectCell(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"yellow";this.deselectCell(e),this.cells[e].classList.add("selected",`selected-${t}`)}deselectCell(e){const t=this.cells[e];t.classList.remove(...Array.from(t.classList).filter((e=>e.startsWith("selected"))))}showCellTooltip(e,t){this.cells[t].title=e}hideCellTooltip(e){this.cells[e].title=""}showDamage(e,t){return new Promise((a=>{const s=this.cells[e],r=document.createElement("span");r.textContent=t,r.classList.add("damage"),s.appendChild(r),r.addEventListener("animationend",(()=>{s.removeChild(r),a()}))}))}setCursor(e){this.boardEl.style.cursor=e}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}}class l{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"generic";if(this.level=e,this.attack=0,this.defence=0,this.health=50,this.type=t,"Character"===new.target.name)throw new Error("Запрещено создавать персонажа базового класса")}}class i{constructor(e,t){if(!(e instanceof l))throw new Error("character must be instance of Character or its children");if("number"!=typeof t)throw new Error("position must be a number");this.character=e,this.position=t}}class c extends l{constructor(e){super(e,"bowman"),this.attack=25,this.defence=25,this.allowableMove=2,this.allowableAttack=2}}class n extends l{constructor(e){super(e,"daemon"),this.attack=10,this.defence=10,this.allowableMove=4,this.allowableAttack=1}}class o extends l{constructor(e){super(e,"magician"),this.attack=10,this.defence=40,this.allowableMove=1,this.allowableAttack=4}}class h extends l{constructor(e){super(e,"swordsman"),this.attack=40,this.defence=10,this.allowableMove=4,this.allowableAttack=1}}class d extends l{constructor(e){super(e,"undead"),this.attack=40,this.defence=10,this.allowableMove=1,this.allowableAttack=4}}class m extends l{constructor(e){super(e,"vampire"),this.attack=25,this.defence=25,this.allowableMove=2,this.allowableAttack=2}}function y(e){return Math.floor(Math.random()*e)}function*u(e,t){const a=y(e.length),s=y(t)+1,r=new e[a](s);yield r}function C(e,t,a){const s=[];for(let r=0;r<a;r+=1){const a=u(e,t).next().value;s.push(a)}return s}var g="auto",p="pointer",v="crosshair",P="not-allowed";class f{static from(e){return null}constructor(e,t,a,s,r,l,i,c){this.theme=e,this.scorePlayer1=t,this.scorePlayer2=a,this.positionedCharacterArray=s,this.selectedIndex=r,this.selectedCharacter=l,this.counterCharacterPlayer1=i,this.counterCharacterPlayer2=c}}const w=new r;w.bindToDOM(document.querySelector("#game-container"));const L=new class{constructor(e){this.storage=e}save(e){this.storage.setItem("state",JSON.stringify(e))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(e){throw new Error("Invalid state")}}}(localStorage),b=new class{constructor(e,t){this.gamePlay=e,this.gamePlay.gameCtrl=this,this.stateService=t}init(){this.gamePlay.currentTheme+=1,this.gamePlay.currentTheme>=this.gamePlay.themesArray.length&&(this.gamePlay.currentTheme=0),this.gamePlay.drawUi(this.gamePlay.themesArray[this.gamePlay.currentTheme]),this.gamePlay.counterCharacterPlayer1=3,this.gamePlay.counterCharacterPlayer2=3,this.gamePlay.roundGameOver=!1,this.gamePlay.gameOver=!1;const e=[],t=C([c,h,o],3,3),a=[];for(let s=0;s<t.length;s+=1){const r=t[s];let l=y(16);for(;a.includes(l);)l=y(16);a.push(l);const c=l%8,n=Math.floor(l/8),o=new i(r,8*c+n);e.push(o)}const s=C([m,d,n],3,3),r=[];for(let t=0;t<s.length;t+=1){const a=s[t];let l=y(16);for(;r.includes(l);)l=y(16);r.push(l);const c=l%8,n=Math.floor(l/8),o=new i(a,8*c+(6+n));e.push(o)}this.gamePlay.cellClickListeners=[],this.gamePlay.cellEnterListeners=[],this.gamePlay.cellLeaveListeners=[],this.gamePlay.newGameListeners=[],this.gamePlay.saveGameListeners=[],this.gamePlay.loadGameListeners=[],this.gamePlay.positionedCharacterArray=e,this.gamePlay.redrawPositions(e),this.gamePlay.addCellEnterListener(this.onCellEnter),this.gamePlay.addCellLeaveListener(this.onCellLeave),this.gamePlay.addCellClickListener(this.onCellClick),this.gamePlay.addNewGameListener(this.init),this.gamePlay.addSaveGameListener(this.saveGame),this.gamePlay.addLoadGameListener(this.loadGame)}saveGame(){const e=this.gamePlay.currentTheme,{scorePlayer1:t}=this.gamePlay,{scorePlayer2:a}=this.gamePlay,{positionedCharacterArray:s}=this.gamePlay,{selectedIndex:r}=this.gamePlay,{selectedCharacter:l}=this.gamePlay,{counterCharacterPlayer1:i}=this.gamePlay,{counterCharacterPlayer2:c}=this.gamePlay,n=new f(e,t,a,s,r,l,i,c);this.stateService.save(n)}loadGame(){const e=this.stateService.load();this.gamePlay.currentTheme=e.theme,this.gamePlay.scorePlayer1=e.scorePlayer1,this.gamePlay.scorePlayer2=e.scorePlayer2,this.gamePlay.drawUi(this.gamePlay.themesArray[this.gamePlay.currentTheme]),this.gamePlay.counterCharacterPlayer1=e.counterCharacterPlayer1,this.gamePlay.counterCharacterPlayer2=e.counterCharacterPlayer2,this.gamePlay.roundGameOver=!1,this.gamePlay.gameOver=!1,this.gamePlay.selectedIndex=e.selectedIndex,this.gamePlay.selectedCharacter=e.selectedCharacter,this.gamePlay.selectedIndex>-1&&this.gamePlay.selectCell(this.gamePlay.selectedIndex),this.gamePlay.positionedCharacterArray=e.positionedCharacterArray,this.gamePlay.redrawPositions(this.gamePlay.positionedCharacterArray)}onCellClick(e){const{gamePlay:t}=this;if(!0===t.gameOver)return;let a=!1;if(t.selectedCharacter){const{allowableMove:s}=t.selectedCharacter,{allowableAttack:r}=t.selectedCharacter,l=e%8,i=Math.floor(e/8),c=t.selectedIndex%8,n=Math.floor(t.selectedIndex/8),o=Math.max(Math.abs(l-c),Math.abs(i-n));if(e!==t.selectedIndex){let h=t.positionedCharacterArray.find((t=>t.position===e));const d=t.positionedCharacterArray.findIndex((t=>t.position===e));if(void 0===h)l!==c&&i!==n&&Math.abs(l-c)!==Math.abs(i-n)||o<=s&&(h=t.positionedCharacterArray.find((e=>e.position===t.selectedIndex)),h.position=e,t.selectedIndexGreen=-1,t.deselectCell(t.selectedIndex),t.selectedIndex=e,t.selectCell(t.selectedIndex),t.redrawPositions(t.positionedCharacterArray),this.appMove());else if(!["bowman","swordsman","magician"].includes(h.character.type)&&o<=r){const s=Math.max(t.selectedCharacter.attack-h.character.defence,.1*t.selectedCharacter.attack);if(h.character.health-=s,h.character.health<0&&(h.character.health=0),0===h.character.health&&(t.positionedCharacterArray.splice(d,1),t.counterCharacterPlayer2-=1,0===t.counterCharacterPlayer2))return t.roundGameOver=!0,void(t.scorePlayer1+=1);a=!0,t.showDamage(e,s).then((()=>{t.redrawPositions(t.positionedCharacterArray),this.appMove()}))}}}t.positionedCharacterArray.forEach((s=>{if(s.position===e){const{character:l}=s;["bowman","swordsman","magician"].includes(l.type)?(t.selectedIndex>=0&&t.deselectCell(t.selectedIndex),t.selectCell(e),t.selectedIndex=e,t.selectedCharacter=l):a||r.showError("Это не персонаж игрока (т.е. не Bowman, Swordsman или Magician).")}}))}appMove(){const{gamePlay:e}=this;let t,a;e.positionedCharacterArray.forEach((e=>{const{character:s}=e;["bowman","swordsman","magician"].includes(s.type)?void 0===a&&(a=e):void 0===t&&(t=e)}));const s=t.position,r=t.character.allowableMove,l=t.character.allowableAttack,i=s%8,c=Math.floor(s/8),n=a.position%8,o=Math.floor(a.position/8),h=Math.abs(c-o),d=c>o?-1:1,m=Math.abs(i-n),y=i>n?-1:1;if(Math.max(Math.abs(c-o),Math.abs(i-n))>l){let a=s;if(0===h){if(m>0){const t=Math.min(m,r);let s=i+y*t;a=8*c+s,e.positionedCharacterArray.forEach((e=>{a===e.position&&(s=i+y*(t-1),a=8*c+s)}))}}else{const t=Math.min(h,r);let s=c+d*t;a=8*s+i,e.positionedCharacterArray.forEach((e=>{a===e.position&&(s=c+d*(t-1),a=8*s+i)}))}t.position=a,e.redrawPositions(e.positionedCharacterArray)}else{const s=Math.max(t.character.attack-a.character.defence,.1*t.character.attack);if(a.character.health-=s,a.character.health<0&&(a.character.health=0),e.showDamage(a.position,s).then((()=>{e.redrawPositions(e.positionedCharacterArray)})),0===a.character.health){const t=e.positionedCharacterArray.findIndex((e=>e.position===a.position));a.character===e.selectedCharacter&&(e.deselectCell(a.position),e.selectedCharacter=null,e.selectedIndex=-1),e.positionedCharacterArray.splice(t,1),e.counterCharacterPlayer1-=1,0===e.counterCharacterPlayer1&&(e.roundGameOver=!0,e.gameOver=!0,e.scorePlayer2+=1)}}}onCellEnter(e){const{gamePlay:t}=this;if(!0!==t.gameOver&&(t.roundGameOver&&(t.gameCtrl.init(),t.roundGameOver=!1),!t.isAppMove&&(t.setCursor(g),t.selectedIndexGreen>=0&&(t.deselectCell(t.selectedIndexGreen),t.selectedIndexGreen=-1),t.selectedIndexRed>=0&&(t.deselectCell(t.selectedIndexRed),t.selectedIndexRed=-1),t.selectedCharacter))){const{allowableMove:a}=t.selectedCharacter,s=e%8,r=Math.floor(e/8),l=t.selectedIndex%8,i=Math.floor(t.selectedIndex/8);if(e!==t.selectedIndex){const c=Math.max(Math.abs(s-l),Math.abs(r-i));s!==l&&r!==i&&Math.abs(s-l)!==Math.abs(r-i)||c<=a&&(t.selectCell(e,"green"),t.selectedIndexGreen=e),t.positionedCharacterArray.forEach((a=>{if(a.position===e){const{character:s}=a,r=function(e){return`🎖 ${e.level} ⚔ ${e.attack} 🛡 ${e.defence} ❤ ${e.health}`}(s);t.showCellTooltip(r,e),["bowman","swordsman","magician"].includes(s.type)?t.setCursor(p):c<=t.selectedCharacter.allowableAttack?(t.setCursor(v),t.selectCell(e,"red"),t.selectedIndexRed=e):t.setCursor(P)}}))}}}onCellLeave(e){this&&this.gamePlay.hideCellTooltip(e)}}(w,L);b.init()}();